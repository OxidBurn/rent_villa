---
name: Code Quality Tooling
status: backlog
created: 2025-10-30T17:15:07Z
updated: 2025-10-30T17:27:00Z
epic: complete-development-pipeline-setup
depends_on: [2]
parallel: false
conflicts_with: [4, 5]
effort: 3-4 hours
priority: P0
---

# Task 006: Code Quality Tooling

## Objective

Configure Prettier for code formatting, enhance ESLint rules for code quality, add import sorting, and integrate all quality checks into the GitHub Actions CI pipeline.

## Context

This task builds upon the CI workflow from Task 001. By adding automated code formatting and enhanced linting, we ensure consistent code style across the team and catch common errors before they reach production.

## Dependencies

**Hard Dependencies:**

- Task 001: GitHub Actions CI Workflow (required for CI integration)

**Conflicts:**

- Task 003: Vitest Test Infrastructure (both modify `.github/workflows/ci.yml`)
- Task 004: Playwright E2E Testing (both modify `.github/workflows/ci.yml`)
  - **Resolution:** Complete after Tasks 003 and 004 to add formatting check to existing workflow

## Scope

### In Scope

- Install and configure Prettier
- Create `.prettierrc` with project formatting rules
- Install Prettier ESLint integration
- Enhance ESLint configuration with recommended rules
- Add import sorting plugin
- Create pre-commit formatting script
- Add formatting check to CI pipeline
- Create VS Code settings for automatic formatting
- Document code style guidelines

### Out of Scope

- Git pre-commit hooks (Husky) - defer to avoid complexity
- EditorConfig file - Prettier handles this
- Custom ESLint rules (use community standards)
- Code complexity metrics (defer to Phase 2)
- Automatic code review tools (defer to Phase 2)

## Implementation Plan

### Step 1: Install Prettier (15 minutes)

**Install dependencies:**

```bash
npm install -D prettier eslint-config-prettier eslint-plugin-prettier
npm install -D @trivago/prettier-plugin-sort-imports
```

**Create Prettier config:** `.prettierrc`

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false,
  "arrowParens": "always",
  "endOfLine": "lf",
  "plugins": ["@trivago/prettier-plugin-sort-imports"],
  "importOrder": ["^react$", "^next/(.*)$", "<THIRD_PARTY_MODULES>", "^@/(.*)$", "^[./]"],
  "importOrderSeparation": true,
  "importOrderSortSpecifiers": true
}
```

**Create ignore file:** `.prettierignore`

```
# Build outputs
.next
out
dist
build

# Dependencies
node_modules

# Cache
.turbo
.cache

# Environment
.env
.env.local
.env.*.local

# Logs
*.log

# Generated files
*.d.ts
coverage
playwright-report
test-results

# Lock files
package-lock.json
pnpm-lock.yaml
yarn.lock
```

### Step 2: Configure ESLint Integration (20 minutes)

**Update ESLint config:** `eslint.config.mjs`

```javascript
import { FlatCompat } from '@eslint/eslintrc'
import { dirname } from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

const compat = new FlatCompat({
  baseDirectory: __dirname,
})

const eslintConfig = [
  ...compat.extends('next/core-web-vitals', 'next/typescript'),
  {
    rules: {
      // Prettier integration
      'prettier/prettier': 'error',

      // Best practices
      'no-console': ['warn', { allow: ['warn', 'error'] }],
      'no-unused-vars': 'off',
      '@typescript-eslint/no-unused-vars': [
        'error',
        { argsIgnorePattern: '^_', varsIgnorePattern: '^_' },
      ],
      '@typescript-eslint/no-explicit-any': 'warn',

      // Code quality
      'prefer-const': 'error',
      'no-var': 'error',
      eqeqeq: ['error', 'always'],

      // React best practices
      'react/self-closing-comp': 'error',
      'react/jsx-curly-brace-presence': ['error', { props: 'never', children: 'never' }],
      'react-hooks/rules-of-hooks': 'error',
      'react-hooks/exhaustive-deps': 'warn',
    },
  },
  {
    ignores: [
      '.next/**',
      'out/**',
      'node_modules/**',
      'dist/**',
      'build/**',
      'coverage/**',
      'playwright-report/**',
      'test-results/**',
    ],
  },
]

export default eslintConfig
```

**Install additional plugins:**

```bash
npm install -D eslint-plugin-prettier
```

### Step 3: Add NPM Scripts (10 minutes)

**Update `package.json`:**

```json
{
  "scripts": {
    "format": "prettier --write .",
    "format:check": "prettier --check .",
    "lint": "next lint",
    "lint:fix": "next lint --fix",
    "quality": "npm run format:check && npm run lint"
  }
}
```

### Step 4: Update CI Workflow (20 minutes)

**Modify `.github/workflows/ci.yml`:**

Add formatting check job (runs in parallel with lint):

```yaml
format:
  name: Format Check
  runs-on: ubuntu-latest

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check code formatting
      run: npm run format:check
```

Update lint job to depend on format:

```yaml
lint:
  name: Lint
  runs-on: ubuntu-latest
  needs: format

  steps:
    # ... existing steps
```

### Step 5: Create VS Code Settings (15 minutes)

**Create workspace settings:** `.vscode/settings.json`

```json
{
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": "explicit"
  },
  "eslint.validate": ["javascript", "javascriptreact", "typescript", "typescriptreact"],
  "typescript.tsdk": "node_modules/typescript/lib",
  "typescript.enablePromptUseWorkspaceTsdk": true,
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[javascript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[javascriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[json]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "files.associations": {
    "*.css": "tailwindcss"
  }
}
```

**Create extensions recommendations:** `.vscode/extensions.json`

```json
{
  "recommendations": [
    "esbenp.prettier-vscode",
    "dbaeumer.vscode-eslint",
    "bradlc.vscode-tailwindcss",
    "ms-playwright.playwright",
    "orta.vscode-jest"
  ]
}
```

### Step 6: Format Existing Code (20 minutes)

**Run formatter on all files:**

```bash
npm run format
```

**Verify changes:**

```bash
git diff
```

**Commit formatting changes:**

```bash
git add .
git commit -m "Apply Prettier formatting to codebase"
```

### Step 7: Documentation (30 minutes)

**Create code style guide:** `docs/code-style-guide.md`

````markdown
# Code Style Guide

## Overview

Rent Villa uses Prettier for automatic code formatting and ESLint for code quality enforcement.

## Automatic Formatting

### VS Code Setup

1. Install recommended extensions (prompted when opening project)
2. Formatting happens automatically on save
3. ESLint issues are fixed on save

### Manual Formatting

Format all files:
npm run format

Check formatting without changes:
npm run format:check

Fix ESLint issues:
npm run lint:fix

Run all quality checks:
npm run quality

## Code Style Rules

### Formatting (Prettier)

- **Semicolons:** Required
- **Quotes:** Single quotes for strings
- **Line length:** 100 characters
- **Indentation:** 2 spaces
- **Trailing commas:** ES5 style
- **Arrow functions:** Always use parentheses

### Import Order

Imports are automatically sorted:

1. React
2. Next.js
3. Third-party packages
4. Project imports (@/...)
5. Relative imports

Example:

```typescript
import React from 'react'

import { useRouter } from 'next/router'

import clsx from 'clsx'
import { format } from 'date-fns'

import { Button } from '@/components/ui/button'
import { formatCurrency } from '@/lib/utils'

import { PropertyCard } from './PropertyCard'
```
````

### Linting Rules

#### TypeScript

- No unused variables (prefix with \_ if intentionally unused)
- No explicit `any` (use `unknown` instead)
- Prefer `const` over `let`
- No `var` declarations

#### React

- Self-closing components when no children
- No unnecessary curly braces in JSX
- Follow Hooks rules (enforced)
- Exhaustive deps in useEffect (warning)

#### General

- Use === instead of ==
- No console.log (use console.warn or console.error)
- Descriptive variable names

## CI Enforcement

All code quality checks run automatically on:

- Every commit (via GitHub Actions)
- Every pull request

**Checks that must pass:**

- ✅ Prettier formatting
- ✅ ESLint rules
- ✅ TypeScript compilation
- ✅ Tests

## Common Issues

### Formatting conflicts

If Prettier and ESLint conflict:

1. Prettier wins (formatting rules)
2. ESLint handles code quality rules
3. `eslint-config-prettier` disables conflicting ESLint rules

### Pre-commit formatting

Run before committing:
npm run quality

Or format specific files:
npx prettier --write src/app/page.tsx

### Ignoring files

Add to `.prettierignore` or `.eslintignore` if needed (rarely).

## Best Practices

1. **Let tools do the work:** Don't manually format code
2. **Trust the formatter:** Prettier's choices are battle-tested
3. **Fix on save:** Enable in VS Code for automatic formatting
4. **Review formatting commits separately:** Keep formatting changes in dedicated commits
5. **Don't fight the tools:** If something feels wrong, discuss with team

## Troubleshooting

**VS Code not formatting:**

- Check Prettier extension is installed
- Verify settings.json has correct configuration
- Reload VS Code window

**ESLint errors not showing:**

- Check ESLint extension is installed
- Verify eslint.config.mjs is valid
- Check output panel for ESLint errors

**Import order wrong:**

- Run: `npm run format`
- Restart TypeScript server (VS Code: Cmd+Shift+P → "Restart TS Server")

````

### Step 8: Validation (15 minutes)

**Local validation:**
```bash
# Check formatting
npm run format:check

# Check linting
npm run lint

# Run all quality checks
npm run quality
````

**CI validation:**

1. Create test PR with unformatted code
2. Verify CI fails on format check
3. Format code and push
4. Verify CI passes

## Technical Decisions

### Decision 1: Prettier for Formatting

**Rationale:**

- Industry standard, opinionated formatter
- Eliminates formatting debates
- Integrates with all editors
- Works with TypeScript, React, CSS

**Alternative Considered:** Manual formatting guidelines
**Why Not:** Error-prone, inconsistent, wastes time in code review

### Decision 2: Import Sorting Plugin

**Rationale:**

- Consistent import order improves readability
- Automatic sorting saves time
- Reduces merge conflicts

**Alternative Considered:** Manual import organization
**Why Not:** Tedious, easy to forget, inconsistent

### Decision 3: No Pre-commit Hooks (Husky)

**Rationale:**

- CI catches formatting issues anyway
- Developers can format manually or on save
- Reduces local setup complexity
- Some developers prefer freedom to commit WIP

**Alternative Considered:** Husky + lint-staged
**Why Not:** Added complexity, can slow down commits, frustrating for some workflows

### Decision 4: Format Check in CI (Not Auto-fix)

**Rationale:**

- Developers should see formatting issues locally
- Auto-formatting in CI can cause confusion
- Encourages editor integration
- Clear feedback loop

**Alternative Considered:** Auto-format and commit in CI
**Why Not:** Unexpected commits, confusion, masks editor setup issues

## Acceptance Criteria

- [ ] Prettier installed and configured
- [ ] `.prettierrc` created with project rules
- [ ] ESLint config enhanced with Prettier integration
- [ ] Import sorting plugin configured
- [ ] NPM scripts created for formatting
- [ ] CI workflow updated with format check
- [ ] VS Code settings created
- [ ] Existing codebase formatted
- [ ] Code style guide documentation created
- [ ] Format check passes in CI

## Definition of Done

- ✅ All acceptance criteria met
- ✅ Code reviewed and approved
- ✅ CI checks passing
- ✅ Documentation reviewed
- ✅ Team walkthrough completed (10 min demo)
- ✅ VS Code extensions installed by team

## Effort Estimate

**Total: 3-4 hours**

- Prettier setup: 0.5 hour
- ESLint integration: 0.5-1 hour
- NPM scripts: 0.25 hour
- CI workflow update: 0.5 hour
- VS Code settings: 0.25-0.5 hour
- Format existing code: 0.5 hour
- Documentation: 0.5-1 hour
- Validation: 0.25-0.5 hour

**Complexity:** Small
**Risk Level:** Low (well-established tools)

## Notes

### Success Metrics

- 100% of code formatted consistently
- Zero formatting debates in code review
- <1 minute to format entire codebase

### Future Enhancements (Post-Epic)

- Pre-commit hooks (optional, team preference)
- Stylelint for CSS (if needed)
- Markdown linting
- Spell checking

### Common Pitfalls to Avoid

- Don't customize Prettier too much (defeats purpose)
- Don't mix formatting and logic changes in same commit
- Don't disable Prettier for large files (fix root cause)
- Don't fight the formatter (trust its decisions)

### Resources

- [Prettier Documentation](https://prettier.io/docs/en/)
- [ESLint Documentation](https://eslint.org)
- [Import Sorting Plugin](https://github.com/trivago/prettier-plugin-sort-imports)
