---
name: Playwright E2E Testing
status: backlog
created: 2025-10-30T17:15:07Z
updated: 2025-10-30T17:27:00Z
epic: complete-development-pipeline-setup
depends_on: [2]
parallel: false
conflicts_with: [4]
effort: 6-8 hours
priority: P1
---

# Task 004: Playwright E2E Testing

## Objective

Set up Playwright for end-to-end testing with browser automation, create sample E2E tests for critical user flows, and integrate test execution into the GitHub Actions CI pipeline.

## Context

This task builds upon the CI workflow established in Task 001. E2E tests will validate complete user journeys in real browser environments, catching integration issues that unit tests cannot detect.

## Dependencies

**Hard Dependencies:**
- Task 001: GitHub Actions CI Workflow (required for CI integration)

**Conflicts:**
- Task 003: Vitest Test Infrastructure (both modify `.github/workflows/ci.yml`)
  - **Resolution:** Task 003 should complete first, then this task adds E2E job to existing workflow

## Scope

### In Scope
- Install and configure Playwright with TypeScript support
- Configure browsers: Chromium, Firefox, WebKit
- Create sample E2E tests for:
  - Homepage rendering
  - Basic navigation flow
  - Form submission (if available)
- Add E2E test job to GitHub Actions workflow
- Configure test execution for PR-only (to save CI time)
- Set up Playwright HTML reporter
- Document test writing guidelines

### Out of Scope
- Visual regression testing (deferred to Phase 2)
- Performance testing (separate concern)
- Cross-browser CI execution (start with Chromium only)
- Test parallelization (defer until test suite grows)
- Playwright UI mode in CI (local development only)

## Implementation Plan

### Step 1: Install Playwright (30 minutes)

**Install dependencies:**
```bash
npm install -D @playwright/test
npx playwright install
```

**Create configuration file:** `playwright.config.ts`
```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

**Update `.gitignore`:**
```
# Playwright
/test-results/
/playwright-report/
/playwright/.cache/
```

### Step 2: Create Sample E2E Tests (2 hours)

**Create test file:** `tests/e2e/homepage.spec.ts`
```typescript
import { test, expect } from '@playwright/test';

test.describe('Homepage', () => {
  test('should load successfully', async ({ page }) => {
    await page.goto('/');

    await expect(page).toHaveTitle(/Rent Villa/);
  });

  test('should display main navigation', async ({ page }) => {
    await page.goto('/');

    const nav = page.locator('nav');
    await expect(nav).toBeVisible();
  });

  test('should be accessible', async ({ page }) => {
    await page.goto('/');

    const accessibilityScanResults = await page.evaluate(() => {
      const images = Array.from(document.querySelectorAll('img'));
      return images.every(img => img.alt !== '');
    });

    expect(accessibilityScanResults).toBeTruthy();
  });
});
```

**Create navigation test:** `tests/e2e/navigation.spec.ts`
```typescript
import { test, expect } from '@playwright/test';

test.describe('Navigation', () => {
  test('should navigate between pages', async ({ page }) => {
    await page.goto('/');

    await expect(page).toHaveURL('/');
  });
});
```

### Step 3: Update GitHub Actions Workflow (1 hour)

**Modify `.github/workflows/ci.yml`:**

Add E2E test job (runs after build job completes):
```yaml
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, build]
    if: github.event_name == 'pull_request' && github.base_ref == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npx playwright test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
```

### Step 4: Add NPM Scripts (15 minutes)

**Update `package.json`:**
```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:report": "playwright show-report"
  }
}
```

### Step 5: Documentation (1 hour)

**Create test guidelines:** `tests/e2e/README.md`
```markdown
# E2E Testing Guide

## Running Tests Locally

Run all E2E tests:
npm run test:e2e

Run in UI mode (interactive):
npm run test:e2e:ui

Debug specific test:
npm run test:e2e:debug

View last test report:
npm run test:e2e:report

## Writing Tests

### Test Structure
- One spec file per page/feature
- Use descriptive test names
- Group related tests with `test.describe()`

### Best Practices
1. Use data-testid attributes for reliable selectors
2. Wait for elements explicitly (avoid fixed timeouts)
3. Test user flows, not implementation details
4. Keep tests independent (no shared state)

### Example Test
```typescript
test('should complete booking flow', async ({ page }) => {
  await page.goto('/');
  await page.getByTestId('book-now-btn').click();

  await expect(page).toHaveURL('/booking');
  await expect(page.getByRole('heading', { name: 'Book Property' })).toBeVisible();
});
```

## CI Execution

E2E tests run automatically on:
- Pull requests to `main` branch
- After all other CI checks pass

Tests run in Chromium browser only (CI optimization).

## Troubleshooting

**Test fails locally but passes in CI:**
- Check viewport size differences
- Verify environment variables

**Test is flaky:**
- Add explicit waits: `await page.waitForLoadState('networkidle')`
- Use `toBeVisible()` instead of `toHaveCount()`
- Increase timeout for specific actions

**Browser not found:**
- Run: `npx playwright install chromium`
```

### Step 6: Validation (30 minutes)

**Verify local execution:**
```bash
npm run test:e2e
```

**Verify CI integration:**
1. Create test PR
2. Confirm E2E job runs only on PR to main
3. Verify test report uploaded as artifact
4. Check job fails if tests fail

## Technical Decisions

### Decision 1: E2E Tests Run on PR to Main Only
**Rationale:**
- E2E tests are slower than unit tests (2-5 minutes)
- Running on every commit wastes CI resources
- PR to main represents critical integration point

**Alternative Considered:** Run on every commit
**Why Not:** Excessive CI time, slows developer feedback loop

### Decision 2: Chromium Only in CI
**Rationale:**
- 90% of issues caught in single browser
- Multi-browser testing is expensive (3x CI time)
- Can run locally for browser-specific debugging

**Alternative Considered:** Test all browsers in CI
**Why Not:** Diminishing returns, focus on speed

### Decision 3: Playwright Over Cypress
**Rationale:**
- Better multi-browser support
- Faster test execution
- Built-in TypeScript support
- Modern API design

**Alternative Considered:** Cypress
**Why Not:** Single-browser focus, slower, older architecture

## Acceptance Criteria

- [ ] Playwright installed with TypeScript configuration
- [ ] Chromium, Firefox, WebKit browsers configured
- [ ] Minimum 3 E2E tests created and passing locally
- [ ] E2E job added to `.github/workflows/ci.yml`
- [ ] E2E tests run only on PR to `main`
- [ ] Test report uploaded as GitHub Actions artifact
- [ ] NPM scripts created for local testing
- [ ] E2E testing documentation created
- [ ] Tests pass in CI on sample PR
- [ ] Failing E2E test blocks PR merge

## Definition of Done

- ✅ All acceptance criteria met
- ✅ Code reviewed and approved
- ✅ Tests passing in CI
- ✅ Documentation reviewed
- ✅ Team walkthrough completed (15 min demo)

## Effort Estimate

**Total: 6-8 hours**

- Setup and configuration: 1-1.5 hours
- Sample test creation: 2-3 hours
- CI integration: 1-1.5 hours
- Documentation: 1-1.5 hours
- Validation and fixes: 0.5-1 hour

**Complexity:** Medium
**Risk Level:** Low (well-documented tool, common patterns)

## Notes

### Success Metrics
- E2E test suite completes in <5 minutes
- Zero flaky tests (99% stability)
- Test failures catch real issues (not false positives)

### Future Enhancements (Post-Epic)
- Visual regression testing with Percy/Chromatic
- Accessibility testing with axe-core
- Performance testing with Lighthouse
- Cross-browser CI execution
- Test parallelization

### Common Pitfalls to Avoid
- Don't test implementation details (test user behavior)
- Avoid brittle selectors (use data-testid)
- Don't share state between tests
- Don't use fixed timeouts (use waitFor)
- Don't over-test (focus on critical paths)

### Resources
- [Playwright Documentation](https://playwright.dev)
- [Best Practices Guide](https://playwright.dev/docs/best-practices)
- [CI Integration Examples](https://playwright.dev/docs/ci)
