---
name: Database & Migration Setup
status: backlog
created: 2025-10-30T17:15:07Z
updated: 2025-10-30T17:27:00Z
epic: complete-development-pipeline-setup
depends_on: [3]
parallel: true
conflicts_with: []
effort: 6-8 hours
priority: P1
---

# Task 005: Database & Migration Setup

## Objective

Set up Vercel Postgres database, integrate Drizzle ORM for type-safe database queries, create a migration system, and configure automatic migration execution during Vercel deployments.

## Context

This task establishes the database foundation for Rent Villa. By using Vercel Postgres and Drizzle ORM, we get seamless integration with Vercel deployments, type-safe queries, and a lightweight migration system.

## Dependencies

**Hard Dependencies:**
- Task 002: Vercel Deployment Setup (required for Vercel Postgres access)

**Parallel Execution:**
- This task can be worked on independently once Vercel account is set up
- Does not conflict with other tasks

## Scope

### In Scope
- Create Vercel Postgres database
- Install and configure Drizzle ORM
- Set up database connection pooling
- Create migration system with Drizzle Kit
- Create sample schema (users, properties tables)
- Configure automatic migrations on deployment
- Create database seed script for development
- Set up database environment variables
- Document migration workflow

### Out of Scope
- Full application schema (separate feature work)
- Database backups (managed by Vercel)
- Read replicas (premature optimization)
- Custom connection pooling (use Vercel's)
- Database monitoring dashboards (use Vercel's)
- Multi-tenant database architecture (future consideration)

## Implementation Plan

### Step 1: Create Vercel Postgres Database (30 minutes)

**Via Vercel Dashboard:**
1. Navigate to Vercel project dashboard
2. Go to "Storage" tab
3. Click "Create Database"
4. Select "Postgres"
5. Choose region (same as deployment region)
6. Name: `rent-villa-production`
7. Click "Create"

**Get connection strings:**
- `POSTGRES_URL` - Full connection string
- `POSTGRES_PRISMA_URL` - For ORM connection
- `POSTGRES_URL_NON_POOLING` - For migrations

**Add to Vercel environment variables:**
```
DATABASE_URL=${POSTGRES_PRISMA_URL}
DATABASE_URL_MIGRATION=${POSTGRES_URL_NON_POOLING}
```

**Add to local `.env.local`:**
```
DATABASE_URL="postgresql://user:password@localhost:5432/rent_villa_dev"
```

### Step 2: Install Drizzle ORM (15 minutes)

**Install dependencies:**
```bash
npm install drizzle-orm postgres
npm install -D drizzle-kit @types/pg
```

**Create Drizzle config:** `drizzle.config.ts`
```typescript
import type { Config } from 'drizzle-kit';

export default {
  schema: './src/db/schema/*',
  out: './src/db/migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
} satisfies Config;
```

### Step 3: Create Database Schema (1.5 hours)

**Create schema directory structure:**
```
src/db/
├── schema/
│   ├── users.ts
│   └── properties.ts
├── migrations/
├── client.ts
└── seed.ts
```

**Create database client:** `src/db/client.ts`
```typescript
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

const connectionString = process.env.DATABASE_URL!;

const client = postgres(connectionString, {
  max: 10,
  idle_timeout: 20,
  connect_timeout: 10,
});

export const db = drizzle(client);
```

**Create users schema:** `src/db/schema/users.ts`
```typescript
import { pgTable, uuid, varchar, timestamp } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: uuid('id').defaultRandom().primaryKey(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  name: varchar('name', { length: 255 }).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export type User = typeof users.$inferSelect;
export type NewUser = typeof users.$inferInsert;
```

**Create properties schema:** `src/db/schema/properties.ts`
```typescript
import { pgTable, uuid, varchar, text, integer, timestamp } from 'drizzle-orm/pg-core';
import { users } from './users';

export const properties = pgTable('properties', {
  id: uuid('id').defaultRandom().primaryKey(),
  ownerId: uuid('owner_id')
    .notNull()
    .references(() => users.id),
  name: varchar('name', { length: 255 }).notNull(),
  address: text('address').notNull(),
  bedrooms: integer('bedrooms').notNull(),
  bathrooms: integer('bathrooms').notNull(),
  monthlyRent: integer('monthly_rent').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export type Property = typeof properties.$inferSelect;
export type NewProperty = typeof properties.$inferInsert;
```

**Create schema index:** `src/db/schema/index.ts`
```typescript
export * from './users';
export * from './properties';
```

### Step 4: Create Migration System (1 hour)

**Add migration scripts to `package.json`:**
```json
{
  "scripts": {
    "db:generate": "drizzle-kit generate",
    "db:migrate": "drizzle-kit migrate",
    "db:push": "drizzle-kit push",
    "db:studio": "drizzle-kit studio",
    "db:seed": "tsx src/db/seed.ts"
  }
}
```

**Generate initial migration:**
```bash
npm run db:generate
```

**Create migration runner:** `src/db/migrate.ts`
```typescript
import { drizzle } from 'drizzle-orm/postgres-js';
import { migrate } from 'drizzle-orm/postgres-js/migrator';
import postgres from 'postgres';

const runMigrations = async () => {
  const connectionString = process.env.DATABASE_URL_MIGRATION || process.env.DATABASE_URL;

  if (!connectionString) {
    throw new Error('DATABASE_URL is not defined');
  }

  const migrationClient = postgres(connectionString, { max: 1 });
  const db = drizzle(migrationClient);

  console.log('Running migrations...');

  await migrate(db, { migrationsFolder: './src/db/migrations' });

  console.log('Migrations completed successfully');

  await migrationClient.end();
};

runMigrations().catch((error) => {
  console.error('Migration failed:', error);
  process.exit(1);
});
```

**Add migration script to package.json:**
```json
{
  "scripts": {
    "db:migrate:run": "tsx src/db/migrate.ts"
  }
}
```

### Step 5: Configure Deployment Migrations (1 hour)

**Update Vercel build settings:**

Create `vercel.json`:
```json
{
  "buildCommand": "npm run db:migrate:run && npm run build",
  "installCommand": "npm ci"
}
```

**Alternative: Use Vercel build script**

Update `package.json`:
```json
{
  "scripts": {
    "vercel-build": "npm run db:migrate:run && npm run build"
  }
}
```

**Test migration locally:**
```bash
npm run db:migrate:run
```

### Step 6: Create Seed Script (1 hour)

**Create seed file:** `src/db/seed.ts`
```typescript
import { db } from './client';
import { users, properties } from './schema';

async function seed() {
  console.log('Seeding database...');

  const [owner] = await db
    .insert(users)
    .values({
      email: 'owner@example.com',
      name: 'John Doe',
    })
    .returning();

  console.log('Created owner:', owner);

  const [property] = await db
    .insert(properties)
    .values({
      ownerId: owner.id,
      name: 'Sunset Villa',
      address: '123 Beach Road, Miami, FL 33139',
      bedrooms: 3,
      bathrooms: 2,
      monthlyRent: 3500,
    })
    .returning();

  console.log('Created property:', property);

  console.log('Seeding completed successfully');
}

seed()
  .catch((error) => {
    console.error('Seed failed:', error);
    process.exit(1);
  })
  .finally(() => {
    process.exit(0);
  });
```

**Install tsx for running TypeScript:**
```bash
npm install -D tsx
```

### Step 7: Create Sample Query (30 minutes)

**Create query example:** `src/db/queries/properties.ts`
```typescript
import { db } from '../client';
import { properties, users } from '../schema';
import { eq } from 'drizzle-orm';

export async function getAllProperties() {
  return db
    .select({
      id: properties.id,
      name: properties.name,
      address: properties.address,
      bedrooms: properties.bedrooms,
      bathrooms: properties.bathrooms,
      monthlyRent: properties.monthlyRent,
      owner: {
        id: users.id,
        name: users.name,
        email: users.email,
      },
    })
    .from(properties)
    .leftJoin(users, eq(properties.ownerId, users.id));
}

export async function getPropertyById(id: string) {
  const [property] = await db
    .select()
    .from(properties)
    .where(eq(properties.id, id))
    .limit(1);

  return property;
}
```

### Step 8: Documentation (1 hour)

**Create database guide:** `docs/database.md`
```markdown
# Database Guide

## Overview

Rent Villa uses Vercel Postgres with Drizzle ORM for type-safe database operations.

## Local Development

### Setup Local Database

Option 1: Use Vercel Postgres (recommended)
1. Pull environment variables: `vercel env pull .env.local`
2. Run migrations: `npm run db:migrate:run`
3. Seed database: `npm run db:seed`

Option 2: Local PostgreSQL
1. Install PostgreSQL
2. Create database: `createdb rent_villa_dev`
3. Update .env.local with connection string
4. Run migrations and seed

### Common Commands

Generate migration from schema changes:
npm run db:generate

Run pending migrations:
npm run db:migrate:run

Push schema changes directly (dev only):
npm run db:push

Open Drizzle Studio (database GUI):
npm run db:studio

Seed development data:
npm run db:seed

## Schema Management

### Creating a New Table

1. Create schema file in `src/db/schema/`
2. Export table definition
3. Add to `src/db/schema/index.ts`
4. Generate migration: `npm run db:generate`
5. Review migration in `src/db/migrations/`
6. Run migration: `npm run db:migrate:run`

### Example Schema

```typescript
import { pgTable, uuid, varchar } from 'drizzle-orm/pg-core';

export const tenants = pgTable('tenants', {
  id: uuid('id').defaultRandom().primaryKey(),
  name: varchar('name', { length: 255 }).notNull(),
});
```

## Querying Data

### Type-Safe Queries

```typescript
import { db } from '@/db/client';
import { properties } from '@/db/schema';
import { eq } from 'drizzle-orm';

const allProperties = await db.select().from(properties);

const property = await db
  .select()
  .from(properties)
  .where(eq(properties.id, propertyId));
```

### Joins

```typescript
const propertiesWithOwners = await db
  .select()
  .from(properties)
  .leftJoin(users, eq(properties.ownerId, users.id));
```

## Migrations in Production

Migrations run automatically on Vercel deployment via `vercel-build` script.

### Manual Migration (if needed)

1. Set DATABASE_URL_MIGRATION in Vercel env vars
2. Run: `vercel env pull`
3. Run: `npm run db:migrate:run`

### Rollback

Drizzle does not support automatic rollback. To rollback:
1. Restore database from Vercel backup
2. Redeploy previous version

## Troubleshooting

**Connection timeout:**
- Check DATABASE_URL is set
- Verify Vercel Postgres is in same region

**Migration fails:**
- Check migration file for syntax errors
- Verify database credentials
- Ensure DATABASE_URL_MIGRATION is set for migrations

**Type errors:**
- Regenerate types: `npm run db:generate`
- Restart TypeScript server
```

### Step 9: Validation (30 minutes)

**Local validation:**
```bash
# Run migrations
npm run db:migrate:run

# Seed database
npm run db:seed

# Open Drizzle Studio
npm run db:studio
```

**Deployment validation:**
1. Deploy to Vercel staging
2. Verify migrations run in build logs
3. Check database in Vercel dashboard
4. Test database connection via API route

## Technical Decisions

### Decision 1: Drizzle ORM Over Prisma
**Rationale:**
- Lighter weight (smaller bundle size)
- Better TypeScript inference
- Simpler migration files (SQL-based)
- Faster query execution

**Alternative Considered:** Prisma
**Why Not:** Heavier, more complex, overkill for current needs

### Decision 2: Automatic Migrations on Deployment
**Rationale:**
- Zero manual steps for database updates
- Ensures schema always matches code
- Reduces deployment errors

**Alternative Considered:** Manual migrations
**Why Not:** Error-prone, requires manual intervention

### Decision 3: Vercel Postgres Over External Provider
**Rationale:**
- Seamless Vercel integration
- Automatic environment variable injection
- Same-region deployment (low latency)
- Built-in connection pooling

**Alternative Considered:** Supabase, PlanetScale
**Why Not:** Additional provider complexity, extra configuration

## Acceptance Criteria

- [ ] Vercel Postgres database created
- [ ] Drizzle ORM installed and configured
- [ ] Sample schema created (users, properties)
- [ ] Migration system working locally
- [ ] Migrations run automatically on Vercel deployment
- [ ] Database seed script created and tested
- [ ] Sample queries implemented and tested
- [ ] Drizzle Studio accessible locally
- [ ] Database documentation created
- [ ] Environment variables configured in Vercel

## Definition of Done

- ✅ All acceptance criteria met
- ✅ Code reviewed and approved
- ✅ Migrations tested in staging
- ✅ Documentation reviewed
- ✅ Team walkthrough completed (20 min demo)

## Effort Estimate

**Total: 6-8 hours**

- Vercel Postgres setup: 0.5-1 hour
- Drizzle installation and config: 0.5-1 hour
- Schema creation: 1.5-2 hours
- Migration system: 1-1.5 hours
- Deployment configuration: 1-1.5 hours
- Seed script: 1 hour
- Documentation: 1-1.5 hours
- Validation: 0.5-1 hour

**Complexity:** Medium
**Risk Level:** Medium (deployment automation requires testing)

## Notes

### Success Metrics
- Migrations complete in <30 seconds
- Zero failed migrations in production
- 100% type coverage for database queries

### Future Enhancements (Post-Epic)
- Database backup automation
- Read replica for analytics
- Multi-tenant schema separation
- Advanced indexing strategies
- Query performance monitoring

### Common Pitfalls to Avoid
- Don't edit generated migration files manually
- Don't skip migration testing in staging
- Don't use `db:push` in production (development only)
- Don't commit `.env.local` to git
- Don't run migrations outside of deployment (except emergencies)

### Resources
- [Drizzle ORM Documentation](https://orm.drizzle.team)
- [Vercel Postgres Guide](https://vercel.com/docs/storage/vercel-postgres)
- [Drizzle Kit CLI](https://orm.drizzle.team/kit-docs/overview)
